---
layout: single
title: MySQLæ…¢æŸ¥è¯¢æ—¶é—´åˆ†æ
description: ä¸»è¦é€šè¿‡æºç åˆ†æä»¥åŠSQLéªŒè¯çš„æ–¹æ³•åˆ†æMySQLæ˜¯å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªSQLæ˜¯å¦å±äºæ…¢æŸ¥è¯¢ï¼Œåˆ¤å®šçš„è¿‡ç¨‹ä¸­æ˜¯å¦è€ƒè™‘MDLé”ã€ROWé”çš„æ—¶é—´ã€‚
headline: ä¸»è¦é€šè¿‡æºç åˆ†æä»¥åŠSQLéªŒè¯çš„æ–¹æ³•åˆ†æMySQLæ˜¯å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªSQLæ˜¯å¦å±äºæ…¢æŸ¥è¯¢ï¼Œåˆ¤å®šçš„è¿‡ç¨‹ä¸­æ˜¯å¦è€ƒè™‘MDLé”ã€ROWé”çš„æ—¶é—´ã€‚
categories: mysql
headline:
tags: [mysql,  æºç é˜…è¯»]
comments: true
published: true
---

### é—®é¢˜

mysqlæ…¢æŸ¥è¯¢åˆ¤æ–­çš„èµ·æ­¢æ—¶é—´æ˜¯ä»€ä¹ˆï¼ŸåŒ…æ‹¬äº†MDLé”ã€ROWé”çš„æ—¶é—´å—ï¼Ÿä»mysqlçš„slow logä¸­çœ‹è¾“å‡ºäº†Query_timeå’ŒLock_timeï¼Œæ„Ÿè§‰ä¸Šåº”è¯¥æ˜¯åŒ…æ‹¬ã€‚

### æºç åˆ†æ

Percona5.6.21

```c

/*åˆ¤æ–­æ˜¯å¦å°†queryè®°å…¥slow logä¸­*/
log_slow_applicable{
	ulonglong query_exec_time= get_query_exec_time(thd, end_utime_of_query);
  	/*é€šè¿‡query_exec_timeå’Œåé¢æåˆ°server_statusåˆ¤æ–­æ˜¯å¦å±äºæ…¢æŸ¥è¯¢*/
}

/*é€šè¿‡server_statusæ ‡è®°thdå½“å‰sqlä¸ºæ…¢æŸ¥è¯¢*/
void update_server_status()
{
  utime_after_query= current_utime();
  if (utime_after_query > utime_after_lock + variables.long_query_time)
    server_status|= SERVER_QUERY_WAS_SLOW;
}

/*è·å–queryæ‰§è¡Œæ—¶é—´çš„æ–¹æ³•ï¼Œcur_utime - thd->utime_after_lock;
å¹¶ä¸”æ ¹æ®queryæ‰§è¡Œæ—¶é—´æ˜¯å¦å¤§äºthd->variables.long_query_timelæ¥æ ‡è®°äº†thdçš„å½“å‰sqlä¸ºæ…¢æŸ¥è¯¢*/
static inline ulonglong get_query_exec_time(THD *thd, ulonglong cur_utime)
{
  ulonglong res;

#ifndef DBUG_OFF
  if (thd->variables.query_exec_time != 0)
    res= thd->lex->sql_command != SQLCOM_SET_OPTION ?
      thd->variables.query_exec_time : 0;
  else
#endif
  res= cur_utime - thd->utime_after_lock;

  if (res > thd->variables.long_query_time)
    thd->server_status|= SERVER_QUERY_WAS_SLOW;
  else
    thd->server_status&= ~SERVER_QUERY_WAS_SLOW;

  return res;
}

/*thdåŒ…æ‹¬start_utime/utime_after_query/utime_after_lock*/


```

slow logçš„åˆ¤æ–­é€»è¾‘å’Œè¾“å‡ºçš„é€»è¾‘æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥å¯¼è‡´å›°æƒ‘ï¼Œåªæœ‰å½“ä¸€ä¸ªqueryæ‰§è¡Œæ—¶é—´ï¼ˆä¸åŒ…æ‹¬é”ç­‰å¾…çš„æ—¶é—´ï¼‰>long_query_timeçš„æ—¶å€™ï¼Œæ‰ä¼šåˆ¤å®šä¼šslow logï¼›ä½†æ˜¯åˆ¤å®šä¸ºslow logä¹‹åï¼Œè¾“å‡ºåŒ…æ‹¬Query_timeï¼ˆæ‰§è¡Œæ—¶é—´+é”ç­‰å¾…æ—¶é—´ï¼‰ï¼Œå¹¶ä¸”ä¹Ÿä¼šè¾“å‡ºLock_timeæ—¶é—´ã€‚

æ‰€ä»¥ä¼šæœ‰è¿™æ ·çš„ç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆDBProxyè®°å½•çš„logæ—¶é—´å¾ˆé•¿ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰åœ¨MySQLçš„slow logä¸­è®°å½•å‘¢ï¼Ÿ

```c++
if(log_slow_applicable(thd)){
  log_slow_do(thd){
    slow_log_print(thd, thd->query(), thd->query_length());
  }
}

bool LOGGER::slow_log_print(THD *thd, const char *query, uint query_length)
{
      if(current_utime < thd->start_utime)
      {
        query_utime= 0;
      }
      else
      {
        query_utime= (current_utime - thd->start_utime);
      }
      if(thd->utime_after_lock < thd->start_utime)
      {
        lock_utime= 0;
      }
      else
      {
        lock_utime= (thd->utime_after_lock - thd->start_utime);
      }

}
```

### SQLéªŒè¯

Percona 5.6.34-79.1-log

```
CREATE TABLE `test` (
  `id` int(11) NOT NULL DEFAULT '0',
  `name` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB
```

session1

```
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> update test set name="xx" where id=4;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> select sleep(5);

mysql> rollback;
Query OK, 0 rows affected (0.03 sec)
```

session2

```
mysql> update test set name="xx1" where id=4 and sleep(0.9);
Query OK, 0 rows affected (22.12 sec)
Rows matched: 0  Changed: 0  Warnings: 0

mysql> update test set name="xx1" where id=4 and sleep(1.1);
Query OK, 0 rows affected (15.38 sec)
Rows matched: 0  Changed: 0  Warnings: 0
```

é’ˆå¯¹session2æŸ¥çœ‹mysql slow logï¼Œç¡®è®¤session2çš„ç¬¬ä¸€ä¸ªSQLæ˜¯æ²¡æœ‰è®°å½•åœ¨æ…¢æŸ¥è¯¢ä¸­çš„ï¼Œå’Œæºç åˆ†ææ˜¯ä¸€è‡´çš„ã€‚

```
# Time: 170125  7:14:39
# User@Host: guest[guest] @ localhost [127.0.0.1]  Id:  5370
# Schema: test  Last_errno: 0  Killed: 0
# Query_time: 15.378555  Lock_time: 14.274847  Rows_sent: 0  Rows_examined: 1  Rows_affected: 0
# Bytes_sent: 52
SET timestamp=1485328479;
update test set name="xx1" where id=4 and sleep(1.1);
```

MySQLç¤¾åŒºç‰ˆï¼ˆ5.7.17ï¼‰ï¼ŒğŸ˜†ï¼ŒåŸè°…æˆ‘ç‰ˆæœ¬æœ‰ç‚¹ä¹±ï¼ŒMySQLç¤¾åŒºç‰ˆå’ŒPerconaç»“æœæ˜¯ä¸€æ ·ï¼Œåªæ˜¯è¾“å‡ºæ²¡æœ‰Perconaçš„ä¸°å¯Œï¼Œç¼ºå°‘äº†Rows_affectedã€Bytes_sentã€‚

```
# Time: 2017-01-25T07:31:52.810785Z
# User@Host: root[root] @ localhost []  Id:     8
# Query_time: 5.422647  Lock_time: 4.319510 Rows_sent: 0  Rows_examined: 1
SET timestamp=1485329512;
update test set name='xx2' where id=1 and sleep(1.1);
```

### ç»“è®º

slow logçš„åˆ¤æ–­é€»è¾‘å’Œè¾“å‡ºçš„é€»è¾‘æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥å¯¼è‡´å›°æƒ‘ï¼Œåªæœ‰å½“ä¸€ä¸ªqueryæ‰§è¡Œæ—¶é—´ï¼ˆä¸åŒ…æ‹¬é”ç­‰å¾…çš„æ—¶é—´ï¼‰>long_query_timeçš„æ—¶å€™ï¼Œæ‰ä¼šåˆ¤å®šä¼šslow logï¼›ä½†æ˜¯åˆ¤å®šä¸ºslow logä¹‹åï¼Œè¾“å‡ºåŒ…æ‹¬Query_timeï¼ˆæ‰§è¡Œæ—¶é—´+é”ç­‰å¾…æ—¶é—´ï¼‰ï¼Œå¹¶ä¸”ä¹Ÿä¼šè¾“å‡ºLock_timeæ—¶é—´ã€‚